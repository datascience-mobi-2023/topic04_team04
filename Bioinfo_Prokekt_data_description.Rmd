---
title: "Bioinfo_Projekt_Data_Description"
author: "Me"
date: "2023-06-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
summary(data_total)
```

```{r}
dimensions= dim(data_total)
R= dimensions[1]

for(Zeile in 1:R){
  Population <- data_total$population_count[Zeile]
  Infection <- data_total$dengue_cases[Zeile]
  Incidence = (Infection/Population)*100000
  data_total$incidence[Zeile] <- Incidence
}
```

# Temperature development in Thailand 2006 - 2022

Creating vector of mean temperature in Thailand over the years

```{r}
 mean_tempvec <- c()
for (month in c(1:180)) {
   tempvec <- c()
  for (district in c(1:77)) {
   temp <- data_total$temperature[month + 180*(district-1)]
   tempvec <- c(tempvec,temp)
  }
 mean_tempvec <- c(mean_tempvec,mean(tempvec))
 }
mean_tempvec
```

#Plot of yearly mean temperature in Thailand over the years + linear regression of temperature

```{r}

# Libraries
library(ggplot2)

# create data
month_dates <- seq(as.Date("2006-01-01"), as.Date("2020-12-01"), by = "month", format = "%m")

xValue <- month_dates
yValue <- mean_tempvec
data <- data.frame(xValue,yValue)

# Plot

ggplot() +
  geom_line(data, mapping=aes(x=xValue, y=yValue)) +
   stat_smooth(method = "lm", col = "red", mapping=aes(x=xValue, y=yValue)) +
  xlab("Years") +
  ylab("Temperature [°C]")
```

# Correlation

```{r}
cor = cor(data_total$incidence, data_total$temperature, use = "pairwise.complete.obs")
plot(data_total$temperature, data_total$incidence, main = "incidence over temperature", xlab = "inzidenz", ylab = "temperature")
```

#ARIMA
```{r}
library(ggplot2)
library(forecast)

Ts_thailand <- ts(total_thailand$dengue_cases, frequency = 12, start = c(2006, 1))
TSstudio::ts_plot(Ts_thailand)

# moving average 
autoplot(Ts_thailand) +
  autolayer(ma(Ts_thailand, order = 12)) +
  xlab("Year") + ylab("dengue_cases") +
  ggtitle("Dengue_cases_thailand_with_MA") 

#additive decomposing
decomposed_thailand_add <- decompose(Ts_thailand, type="additive") # use type = "additive" for additive components
plot(decomposed_thailand_add)
grid(lty = 2, col = "gray")
                      
#seasonal decomposing
decomposed_thailand_seas <- stl(Ts_thailand, s.window = "periodic")
plot(decomposed_thailand_seas, main = "Decomposition of a periodic time series", xaxt = "n")
grid(lty = 2, col = "gray")


library(tseries)
adf.test(Ts_thailand) # p-value (0.01) < 0.05 indicates the TS is stationary --> suggests it is stationary


acf_thailand <- acf(total_thailand$dengue_cases)

pacf_thailand <- pacf(total_thailand$dengue_cases)

```

```{r}
library(forecast)
auto_thailand  <- auto.arima(Ts_thailand)
auto_thailand

#auto_thailand_2  <- auto.arima(Ts_thailand, stepwise = F, approximation = F)
#auto_thailand_2
#this auto-ARIMA was removed because it took to long and had a higher AIC
```


```{r}
residuals_thailand <- residuals(auto_thailand)
plot(residuals_thailand)

acf(residuals_thailand)

portmanteau_thailand <- Box.test(residuals_thailand, lag = 12, type = "Ljung-Box")
portmanteau_thailand 
# --> p value (0.52) > 0.05 --> no evidence for autocorrelation --> ARIMA model works well
```

```{r}
library(forecast)
horizon_thailand <- 12 
forecasted_thailand <- forecast(auto_thailand, h = horizon_thailand)

forecastedTs_thailand <- forecasted_thailand$mean
forecastedTs_thailand  <- ts(forecastedTs_thailand, frequency = 12, start = c(2021, 1) )
plot(forecastedTs_thailand)
```

```{r}
forecastDf_thailand <- as.data.frame(forecasted_thailand)
forecastDf_thailand$time <- time(forecastedTs_thailand)
names(forecastDf_thailand) <- c("point", "lo_80", "hi_80" , "lo_95", "hi_95", "time")
```

```{r}
library(ggplot2)
ggplot() +
  geom_line(data = Ts_thailand, aes(x = time(Ts_thailand), y = Ts_thailand), color = "black") +
  geom_ribbon(data = forecastDf_thailand, aes(x = time, ymin = lo_95, ymax = hi_95), fill = "gray80") +
  geom_line(data = forecastDf_thailand, aes(x = time, y = point), color = "blue") +
  labs(title = "Time Series Forecast") +
  xlab("Year") +
  ylab("Dengue Cases") +
  theme_minimal()
```

```{r}
library(forecast)
#exclude_end <- 3
Ts_thailand_2018 = window(Ts_thailand, end = c(2018, 12))

auto_thailand_2018  <- auto.arima(Ts_thailand_2018)
auto_thailand_2018


horizon_thailand <- 12 
forecasted_thailand_2018 <- forecast(auto_thailand_2018, h = horizon_thailand)

forecastedTs_thailand_2018 <- forecasted_thailand_2018$mean
forecastedTs_thailand_2018  <- ts(forecastedTs_thailand_2018, frequency = 12, start = c(2018, 1) )
plot(forecastedTs_thailand_2018)

forecastDf_thailand_2018 <- as.data.frame(forecasted_thailand_2018)
forecastDf_thailand_2018$time <- time(forecastedTs_thailand_2018)
names(forecastDf_thailand_2018) <- c("point", "lo_80", "hi_80" , "lo_95", "hi_95", "time")

library(ggplot2)
ggplot() +
  geom_ribbon(data = forecastDf_thailand_2018, aes(x = time, ymin = lo_95, ymax = hi_95), fill = "gray80") +
  geom_line(data = forecastDf_thailand_2018, aes(x = time, y = point), color = "blue") +
  geom_line(data = Ts_thailand, aes(x = time(Ts_thailand), y = Ts_thailand), color = "black") +
  labs(title = "Time Series Forecast") +
  xlab("Year") +
  ylab("Dengue Cases") +
  theme_minimal()
```



#comparing the decomposition of temperature and cases

```{r}
library(ggplot2)
library(forecast)
library(gridExtra)

total_thailand_temp = cbind(total_thailand, mean_tempvec)
colnames(total_thailand_temp)[4] = "temperature"

Ts_thailand_temp <- ts(total_thailand_temp$temperature, frequency = 12, start = c(2006, 1))
TSstudio::ts_plot(Ts_thailand_temp)

#additive decomposing of the temperature
decomposed_thailand_add_temp <- decompose(Ts_thailand_temp, type="additive") 
plot(decomposed_thailand_add_temp)
grid(lty = 2, col = "gray")

#additive decomposing of the dengue cases
decomposed_thailand_add <- decompose(Ts_thailand, type="additive")
plot(decomposed_thailand_add)
grid(lty = 2, col = "gray")

case_trend <- decomposed_thailand_add$trend
temp_trend <- decomposed_thailand_add_temp$trend

plot_case_trend <- ggplot(case_trend, aes(x, y)) + geom_line() + labs(title = "Cases_trend")
plot_temp_trend <- ggplot(temp_trend, aes(x, y)) + geom_line() + labs(title = "Temperature_trend")

plot_case_temp_trend <- grid.arrange(plot_case_trend, plot_temp_trend, ncol = 1)
print(plot_case_temp_trend)


```


```{r}
case_seasonal <- decomposed_thailand_add$seasonal
temp_seasonal <- decomposed_thailand_add_temp$seasonal

plot_case_seasonal <- ggplot(case_seasonal, aes(x, y)) + geom_line() + labs(title = "Cases_seasonal")
plot_temp_seasonal <- ggplot(temp_seasonal, aes(x, y)) + geom_line() + labs(title = "Temperature_seasonal")

plot_case_temp_seasonal <- grid.arrange(plot_case_seasonal, plot_temp_seasonal, ncol = 1)
print(plot_case_temp_trend)

```
#mean of dengue_cases and temperature of whole thailand per month
```{r}
library(ggplot2)
library(scales)

#dengue cases of whole thailand per month
f_mean_dengue = function(){
  mean_dengue <- data.frame(dengue_cases = numeric(), time_column = as.Date(character()))
  months = seq(from = as.Date("2006-01-01"), to = as.Date("2020-12-01"), by = "month")
  for (i in months) {
    month = data_total[data_total$time_column == i,]
    m_month = data.frame(dengue_cases = mean(month$dengue_cases, na.rm = TRUE), time_column = month$time_column[1])
    mean_dengue = rbind(mean_dengue, m_month)
  }
  return(mean_dengue)
}


f_mean_temp = function(){
  mean_temp <- data.frame(temperature = numeric(), time_column = as.Date(character()))
  months = seq(from = as.Date("2006-01-01"), to = as.Date("2020-12-01"), by = "month")
  for (i in months) {
    month = data_total[data_total$time_column == i,]
    m_month = data.frame(temperature = mean(month$temperature, na.rm = TRUE), time_column = month$time_column[1])
    mean_temp = rbind(mean_temp, m_month)
  }
  return(mean_temp)
}

plot1 = ggplot2::ggplot() +
  geom_line(data = f_mean_dengue(), aes(x = time_column, y = dengue_cases)) +
  labs(x = "time", y = "dengue-cases") +
  scale_x_continuous(breaks = seq(from = as.Date("2006-01-01"), to = as.Date("2020-12-01"), by = "2 year"))

plot2 = ggplot2::ggplot() +
  geom_line(data = f_mean_temp(), aes(x = time_column, y = temperature), color = "red") +
  labs(x = "time", y = "temperature") +
  scale_x_continuous(breaks = seq(from = as.Date("2006-01-01"), to = as.Date("2020-12-01"), by = "2 year"))


gridExtra::grid.arrange(plot1, plot2, nrow = 2)
```

#mean and median comparison

```{r}
library(ggplot2)

f_median_dengue = function(){
  median_dengue <- data.frame(dengue_cases = numeric(), time_column = as.Date(character()))
  months = seq(from = as.Date("2006-01-01"), to = as.Date("2020-12-01"), by = "month")
  for (i in months) {
    month = data_total[data_total$time_column == i,]
    m_month = data.frame(dengue_cases = median(month$dengue_case, na.rm = TRUE), time_column = month$time_column[1])
    median_dengue = rbind(median_dengue, m_month)
  }
  return(median_dengue)
}

f_median_temp = function(){
  median_temp <- data.frame(temperature = numeric(), time_column = as.Date(character()))
  months = seq(from = as.Date("2006-01-01"), to = as.Date("2020-12-01"), by = "month")
  for (i in months) {
    month = data_total[data_total$time_column == i,]
    m_month = data.frame(temperature = median(month$temperature, na.rm = TRUE), time_column = month$time_column[1])
    median_temp = rbind(median_temp, m_month)
  }
  return(median_temp)
}
#compute difference between mean and median
dif_mm_dengue = f_mean_dengue()["dengue_cases"]-f_median_dengue()["dengue_cases"]
dif_mm_dengue = cbind(dif_mm_dengue,f_mean_dengue()["time_column"])

dif_mm_temp = f_mean_temp()["temperature"]-f_median_temp()["temperature"]
dif_mm_temp = cbind(dif_mm_temp,f_mean_temp()["time_column"])

plot_mean_temp = ggplot2::ggplot() +
  geom_line(data = f_mean_temp(), aes(x = time_column, y = temperature)) +
  labs(x = "time", y = "temperature", title = "Mean temperature")

plot_mean_dengue = ggplot2::ggplot() +
  geom_line(data = f_mean_dengue(), aes(x = time_column, y = dengue_cases)) +
  labs(x = "time", y = "dengue-cases", title = "Mean dengue cases")

plot_median_temp = ggplot2::ggplot() +
  geom_line(data = f_median_temp(), aes(x = time_column, y = temperature)) +
  labs(x = "time", y = "temperature", title = "Median temperature")

plot_median_dengue = ggplot2::ggplot() +
  geom_line(data = f_median_dengue(), aes(x = time_column, y = dengue_cases)) +
  labs(x = "time", y = "dengue-cases", title = "Median dengue cases")

plot_dif_dengue = ggplot2::ggplot() +
  geom_line(data = dif_mm_dengue, aes(x = time_column, y = dengue_cases)) +
  labs(x = "time", y = "dengue-cases", title = "Difference between mean and median")

plot_dif_temp = ggplot2::ggplot() +
  geom_line(data = dif_mm_temp, aes(x = time_column, y = temperature)) +
  labs(x = "time", y = "temperature", title = "Difference between mean and median")

gridExtra::grid.arrange(plot_mean_dengue, plot_mean_temp, plot_median_dengue, plot_median_temp,plot_dif_dengue,plot_dif_temp, nrow = 3)
```

#mean of dengue_cases and temperature of whole thailand per year
```{r}
f_mean_dengue.y.t = function(){
  mean_dengue.y.t <- data.frame(dengue_cases = numeric(), time_column = as.Date(character()))
  for (i in c(2006:2020)) {
    month = data_total[data_total$year == i,]
    m_month = data.frame(dengue_cases = mean(month$dengue_cases, na.rm = TRUE), time_column = month$time_column[1])
    mean_dengue.y.t = rbind(mean_dengue.y.t, m_month)
  }
  return(mean_dengue.y.t)
}
mean_dengue.y.t = as.data.frame(f_mean_dengue.y.t())

f_mean_temp.y.t = function(){
  mean_temp.y.t <- data.frame(temperature = numeric(), time_column = as.Date(character()))
  for (i in c(2006:2020)) {
    month = data_total[data_total$year == i,]
    m_month = data.frame(temperature = mean(month$temperature, na.rm = TRUE), time_column = month$time_column[1])
    mean_temp.y.t = rbind(mean_temp.y.t, m_month)
  }
  return(mean_temp.y.t)
}
mean_temp.y.t = as.data.frame(f_mean_temp.y.t())

```

#Plot für Bangkok

```{r}
dengue_plot_cases = c()
dengue_plot_time = c()

dengue_plot_cases <- data_total$dengue_cases[data_total$Reporting_areas == "Bangkok"]
dengue_plot_time <- data_total$time_column[data_total$Reporting_areas == "Bangkok"]

plot(dengue_plot_time,dengue_plot_cases, type = "o")
```

#distribution of incidence
```{r}
q.dengue = quantile(data_total$incidence, probs = c(0.01,0.1,0.25,0.5,0.75,0.9,0.99), na.rm = TRUE)
hist(data_total$incidence,  breaks = 200, main = "Distribution of incidence", xlab = "incidence", freq = TRUE);abline(v=q.dengue,lty=3,lwd=2,col='red')
```

#correlation between temperature and dengue cases

```{r}
i.missing = which(rmv.rows > 0)


plot(data_total$temperature, data_total$incidence, pch = 20,
     ylab = "incidence",
     xlab = "mean temperature",
     lines(data_total$temperature, data_total$incidence, col = "red")
     )

```

#probieren mit time series Objekten

```{r}
my_ts <- ts(data_total$dengue_cases, start = c(data_total$time_column[1]), frequency = 12)
head(my_ts)
TSstudio::ts_plot(my_ts)
```

#GAM

```{r}

library(readxl)
library(nlme)
library(gam)
library(sdm)
library(raster)
library(ncdf4)
library(mgcv)

attach(data_total)
model1 <- gam(dengue_cases~s(temperature, k=6), family="quasipoisson")
plot.gam(model1)
summary(model1)
k.check(model1)
gam.check(model1)

linear_model <- gam(dengue_cases~temperature)
smooth_model <- gam(dengue_cases~s(temperature))

AIC(linear_model, smooth_model)
```

```{r}
library(readxl)
library(nlme)
library(gam)
library(sdm)
library(raster)
library(ncdf4)
library(mgcv)

attach(data_total)
model2 <- gam(incidence~s(population_count, k=5), family="quasipoisson")
plot.gam(model2)
summary(model2)
k.check(model2)
gam.check(model2)

```
